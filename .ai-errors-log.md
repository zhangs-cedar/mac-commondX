# 🤖 AI 自我进化日志 (.ai-errors-log.md)

> 此文件是 AI 的外部长期记忆。
> **指令**：每次开始新任务前，AI 必须读取此文件，检查是否有相关的历史错误模式，避免重蹈覆辙。

## 🧠 错误模式库 (Pattern Library)
此处记录高频错误模式，AI 编码前需强制检索。

### 通用模式

- **PATTERN-001**: 路径拼接错误（跨平台兼容性）
  - **特征**: 使用 `+ '\\'` 或 `+ '/'` 拼接路径
  - **修正**: 必须使用 `os.path.join(base, sub, file)`
  - **规则**: `.cursorrules/路径处理`
  - **示例**:
    ```python
    # ❌ 错误
    path = base_dir + '\\' + filename
    # ✅ 正确
    path = os.path.join(base_dir, filename)
    ```

- **PATTERN-002**: 类型提示过度复杂
  - **特征**: 使用 `Optional[str] = None` 等复杂类型提示
  - **修正**: 遵循 liuns 风格，简化为 `str = None`
  - **规则**: `.cursorrules/代码风格 - 简洁、优化、易读`
  - **示例**:
    ```python
    # ❌ 过度复杂
    from typing import Optional
    def func(file: Optional[str] = None) -> str:
    # ✅ 简洁
    def func(file: str = None) -> str:
    ```


---

## 📜 详细错误流水 (Event Log)

### [2026-01-07] 简化类型提示，代码更简洁
- **Context**: `cedar/utils/s_print.py` 第 50 行函数参数类型提示
- **Pattern**: PATTERN-002
- **Error**: 使用 `Optional[str] = None` 过度复杂
- **Root Cause**: 不符合 liuns 风格（简洁、优化、易读）
- **Fix**: 简化为 `str = None`，移除 `Optional` 导入
- **Impact**: 代码更简洁易读，符合项目代码规范
- **Code**:
  ```python
  # 修改前
  from typing import Any, Optional
  def print(*args: Any, sep: str = ' ', end: str = '\n', file: Optional[str] = None) -> str:
  
  # 修改后
  from typing import Any
  def print(*args: Any, sep: str = ' ', end: str = '\n', file: str = None) -> str:
  ```
- **知识点**: Python 类型提示简化，遵循项目代码风格规范

### [2026-01-08] macOS 通知不可靠，改用弹窗对话框
- **Context**: `src/status_bar.py` 第 370 行 `showAbout_` 方法
- **Pattern**: PATTERN-003 (新增)
- **Error**: 使用 `NSUserNotificationCenter` 发送通知，用户点击后无反应
- **Root Cause**: macOS 通知中心可能被禁用、静默或需要权限
- **Fix**: 改用 `NSAlert` 弹窗对话框，更可靠且信息更丰富
- **Impact**: 用户体验提升，确保信息展示
- **Code**:
  ```python
  # 修改前 (不可靠)
  def showAbout_(self, sender):
      self.send_notification("CommondX", "Mac 文件剪切移动工具")
  
  # 修改后 (可靠)
  def showAbout_(self, sender):
      from AppKit import NSAlert, NSApp
      alert = NSAlert.alloc().init()
      alert.setMessageText_("CommondX")
      alert.setInformativeText_("详细信息...")
      alert.addButtonWithTitle_("确定")
      NSApp.activateIgnoringOtherApps_(True)
      alert.runModal()
  ```
- **知识点**: macOS 开发中，重要信息展示优先使用 `NSAlert`，通知仅用于后台提醒

### 通用模式 (新增)

- **PATTERN-003**: macOS 通知不可靠
  - **特征**: 使用 `NSUserNotificationCenter` 展示重要信息
  - **修正**: 重要信息用 `NSAlert` 弹窗，通知仅用于后台提醒
  - **规则**: 用户交互可靠性优先

- **PATTERN-004**: PyInstaller 打包后路径问题
  - **特征**: 使用 `__file__` 定位配置文件
  - **修正**: 打包后 bundle 内文件只读，用户数据需存到 `~/Library/Application Support/`
  - **规则**: 静态配置写代码里，动态数据存用户目录

- **PATTERN-005**: Finder 目标文件夹检测不准
  - **特征**: 使用 `target of front window` 获取目标路径
  - **修正**: 使用 `insertion location` 获取准确的插入位置
  - **规则**: AppleScript 优先使用原生属性

- **PATTERN-006**: macOS 辅助功能权限基于路径
  - **特征**: 每次打包后需重新授权
  - **修正**: 打包脚本添加 `tccutil reset Accessibility` 清除旧记录
  - **规则**: 开发时自动清理授权缓存

---

### [2026-01-08] 许可证管理简化
- **Context**: `src/license_manager.py` 配置存储
- **Pattern**: PATTERN-004
- **Error**: 配置文件在打包后无法写入（bundle 只读）
- **Fix**: 静态配置（trial_days）写代码里，用户数据存 `~/Library/Application Support/CommondX/user.yaml`
- **Impact**: 打包后激活功能正常工作

### [2026-01-08] 权限管理模块化
- **Context**: 辅助功能权限分散在多个文件
- **Fix**: 创建 `src/permission.py` 统一管理
  - `check_accessibility()` - 检查权限
  - `request_accessibility()` - 请求权限
  - `open_accessibility_settings()` - 打开系统设置
- **Impact**: 代码更清晰，状态栏菜单支持手动检查权限

### [2026-01-08] 桌面文件移动修复
- **Context**: `src/cut_manager.py` 获取目标文件夹
- **Pattern**: PATTERN-005
- **Error**: 使用 `target of front window` 无法准确检测桌面
- **Fix**: 改用 `insertion location` 获取 Finder 当前插入位置
- **Code**:
  ```applescript
  -- 修改前
  return POSIX path of (target of front window as alias)
  
  -- 修改后
  set insertLoc to insertion location as alias
  return POSIX path of insertLoc
  ```
- **Impact**: 文件可正确移动到桌面

### [2026-01-08] 打包脚本优化
- **Context**: `tools/build_dmg.sh`
- **Pattern**: PATTERN-006
- **Fix**: 打包前自动清除辅助功能授权记录
- **Code**:
  ```bash
  tccutil reset Accessibility com.liuns.commondx 2>/dev/null || true
  ```
- **Impact**: 避免每次打包后手动清理授权