# CommondX 处理流程图

## Cmd+X 快捷键处理流程

```mermaid
flowchart TD
    Start([用户按下 Cmd+X]) --> EventTap[EventTap 捕获键盘事件]
    EventTap --> CheckKey{是否为 Cmd+X?}
    CheckKey -->|否| PassEvent[放行事件]
    CheckKey -->|是| CheckFinder{是否为 Finder 窗口?}
    CheckFinder -->|否| PassEvent
    CheckFinder -->|是| OnCut[调用 app.on_cut]
    
    OnCut --> CheckLicense{检查许可证}
    CheckLicense -->|无效| ShowActivation[显示激活提示]
    CheckLicense -->|有效| CallCut[调用 cut_manager.cut]
    
    CallCut --> GetSelection[获取 Finder 选中文件]
    GetSelection --> HasFiles{是否有文件?}
    HasFiles -->|否| ResetState[重置状态<br/>last_selection = None<br/>count = 0]
    ResetState --> ReturnFalse[返回 False, False]
    
    HasFiles -->|是| ValidateFiles[验证文件是否存在]
    ValidateFiles --> FilesValid{文件有效?}
    FilesValid -->|否| ResetState
    
    FilesValid -->|是| CompareSelection[比较当前选择与上一次选择<br/>_is_same_selection]
    CompareSelection --> IsSame{选择是否相同?}
    
    IsSame -->|是| IncrementCount[计数 +1<br/>same_selection_count++]
    IsSame -->|否| ResetCount[重置计数为 1<br/>same_selection_count = 1]
    
    IncrementCount --> UpdateLast[更新 last_selection]
    ResetCount --> UpdateLast
    
    UpdateLast --> CheckCount{检查计数}
    CheckCount -->|count == 2| ShowDialog[返回 True, True<br/>触发智能操作弹窗]
    CheckCount -->|count > 2| Silent[返回 True, False<br/>保持静默]
    CheckCount -->|count == 1| DoCut[执行剪切操作<br/>更新 cut_files<br/>返回 True, False]
    
    ShowDialog --> HandleDialog[app._handle_file_operation]
    Silent --> End1[结束]
    DoCut --> SendNotify[发送通知<br/>已剪切 N 个文件]
    SendNotify --> End2[结束]
    ReturnFalse --> End3[结束]
    
    HandleDialog --> ShowFileDialog[显示文件智能操作弹窗]
    ShowFileDialog --> UserChoice{用户选择操作}
    UserChoice -->|复制路径| CopyPaths[复制文件路径到剪贴板]
    UserChoice -->|压缩为ZIP| Compress[调用 compress_to_zip]
    UserChoice -->|智能解压| Decompress[调用 decompress_archive]
    UserChoice -->|取消| End4[结束]
    
    CopyPaths --> NotifyCopy[通知: 已复制路径]
    Compress --> NotifyCompress{压缩成功?}
    Decompress --> NotifyDecompress{解压成功?}
    
    NotifyCompress -->|是| NotifySuccess1[通知: 压缩成功]
    NotifyCompress -->|否| NotifyFail1[通知: 压缩失败]
    NotifyDecompress -->|是| NotifySuccess2[通知: 解压成功]
    NotifyDecompress -->|否| NotifyFail2[通知: 解压失败]
    
    NotifyCopy --> End5[结束]
    NotifySuccess1 --> End6[结束]
    NotifyFail1 --> End7[结束]
    NotifySuccess2 --> End8[结束]
    NotifyFail2 --> End9[结束]
    ShowActivation --> End10[结束]
    PassEvent --> End11[结束]
```

## 状态跟踪逻辑

```mermaid
stateDiagram-v2
    [*] --> 初始状态: 应用启动
    
    初始状态 --> 第一次选择: Cmd+X 选择文件A
    第一次选择 --> 执行剪切: 更新 cut_files
    执行剪切 --> 等待第二次: 保存 last_selection = A<br/>count = 1
    
    等待第二次 --> 第二次相同选择: Cmd+X 再次选择文件A
    第二次相同选择 --> 触发弹窗: count = 2<br/>不更新 cut_files
    触发弹窗 --> 等待第三次: 保存 last_selection = A<br/>count = 2
    
    等待第三次 --> 第三次相同选择: Cmd+X 再次选择文件A
    第三次相同选择 --> 保持静默: count = 3<br/>不更新 cut_files
    保持静默 --> 等待第四次: 保存 last_selection = A<br/>count = 3
    
    等待第二次 --> 选择不同文件: Cmd+X 选择文件B
    选择不同文件 --> 执行剪切: 重置 count = 1<br/>更新 last_selection = B
    执行剪切 --> 等待第二次
    
    等待第三次 --> 选择不同文件2: Cmd+X 选择文件B
    选择不同文件2 --> 执行剪切2: 重置 count = 1<br/>更新 last_selection = B
    执行剪切2 --> 等待第二次
    
    保持静默 --> 选择不同文件3: Cmd+X 选择文件B
    选择不同文件3 --> 执行剪切3: 重置 count = 1<br/>更新 last_selection = B
    执行剪切3 --> 等待第二次
```

## 核心设计逻辑

### 1. 选择比较机制
- 使用 `set()` 比较文件列表，忽略顺序
- 比较的是文件路径的集合

### 2. 状态计数规则
- **第一次选择**：`count = 1`，执行剪切，更新 `cut_files`
- **第二次相同选择**：`count = 2`，触发智能操作弹窗，**不更新** `cut_files`
- **第三次及以后相同选择**：`count >= 3`，保持静默，**不更新** `cut_files`
- **选择不同文件**：重置 `count = 1`，重新开始计数

### 3. 智能操作弹窗
- 仅在 `count == 2` 时触发
- 显示文件列表和可用操作
- 根据文件类型智能显示按钮：
  - 全部是压缩文件 → 显示"智能解压"
  - 有普通文件/文件夹 → 显示"压缩为 ZIP"
  - 始终显示"复制路径"

### 4. 操作处理
- **复制路径**：将文件路径列表复制到剪贴板
- **压缩为 ZIP**：调用 `compress_to_zip()` 压缩文件
- **智能解压**：调用 `decompress_archive()` 解压压缩文件

## 关键代码位置

- **事件捕获**: `src/event_tap.py` - `EventTap._callback()`
- **主逻辑**: `src/app.py` - `CommondXApp.on_cut()`
- **选择管理**: `src/cut_manager.py` - `CutManager.cut()`
- **弹窗显示**: `src/file_dialog.py` - `show_file_operations_dialog()`
- **操作处理**: `src/app.py` - `CommondXApp._handle_file_operation()`
