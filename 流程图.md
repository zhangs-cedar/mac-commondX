# CommondX 处理流程图

## ⌘+X 快捷键处理流程

```mermaid
flowchart TD
    Start(["用户按下 ⌘+X"]) --> EventTap[EventTap 捕获键盘事件]
    EventTap --> CheckKey{是否为 ⌘+X?}
    CheckKey -->|否| PassEvent[放行事件]
    CheckKey -->|是| CheckFinder{是否为 Finder 窗口?}
    CheckFinder -->|否| PassEvent
    CheckFinder -->|是| CheckLicense{检查许可证}
    
    CheckLicense -->|无效| ShowActivation[显示激活提示]
    CheckLicense -->|有效| OnCut["调用 app.on_cut()"]
    
    OnCut --> CallCut["调用 cut_manager.cut()"]
    CallCut --> GetSelection["获取 Finder 选中文件<br/>(没有则返回空列表)"]
    GetSelection --> HasFiles{是否有文件?}
    
    HasFiles -->|否| UpdateLastEmpty["更新 last_selection = []"]
    HasFiles -->|是| CompareSelection["比较当前选择与上一次选择<br/>(使用 set 比较，忽略顺序)"]
    
    CompareSelection --> IsSame{选择是否相同?}
    IsSame -->|是| UpdateLastSame["更新 last_selection = 当前选择"]
    IsSame -->|否| ValidateFiles["验证文件是否存在"]
    
    UpdateLastSame --> ReturnShowDialog["返回 (True, True)<br/>触发智能操作菜单"]
    UpdateLastEmpty --> ReturnFalse["返回 (False, False)"]
    
    ValidateFiles --> FilesValid{文件有效?}
    FilesValid -->|否| ReturnFalse
    FilesValid -->|是| DoCut["执行剪切操作<br/>(更新 cut_files, 更新 last_selection = 当前选择)"]
    
    DoCut --> SendNotify["发送通知: 已剪切 N 个文件"]
    SendNotify --> End[结束]
    
    ReturnShowDialog --> ShowMenu[显示文件智能操作菜单<br/>（状态栏菜单，支持键盘导航）]
    
    ShowMenu --> UserChoice{用户选择操作<br/>（键盘上下键选择，回车确认）}
    UserChoice -->|复制路径| CopyPaths[复制文件路径到剪贴板]
    UserChoice -->|压缩为ZIP| Compress[调用 compress_to_zip]
    UserChoice -->|智能解压| Decompress[调用 decompress_archive]
    UserChoice -->|MD转HTML| MdToHtml[调用 convert_md_to_html]
    UserChoice -->|MD转PDF| MdToPdf[调用 convert_md_to_pdf]
    UserChoice -->|取消| ResetLastSelection["重置 last_selection = None<br/>(保持状态以便重试)"]
    
    CopyPaths --> NotifySuccess["通知操作结果"]
    Compress --> CheckCompress{压缩成功?}
    Decompress --> CheckDecompress{解压成功?}
    MdToHtml --> CheckMdHtml{转换成功?}
    MdToPdf --> CheckMdPdf{转换成功?}
    
    CheckCompress -->|是| NotifySuccess
    CheckCompress -->|否| NotifyFail["通知操作失败"]
    CheckDecompress -->|是| NotifySuccess
    CheckDecompress -->|否| NotifyFail
    CheckMdHtml -->|是| NotifySuccess
    CheckMdHtml -->|否| NotifyFail
    CheckMdPdf -->|是| NotifySuccess
    CheckMdPdf -->|否| NotifyFail
    
    NotifySuccess --> ResetLastSelection
    NotifyFail --> ResetLastSelection
    ResetLastSelection --> End
    ReturnFalse --> End
    ShowActivation --> End
    PassEvent --> End
```

## 核心设计逻辑

### 1. 选择比较机制
- 使用 `set()` 比较文件列表，忽略顺序
- 空列表 `[]` 和 `None` 被视为相同（都是空选择）
- 比较结果决定是执行剪切还是显示智能操作菜单

### 2. 处理规则
- **选择与上次不同**：执行剪切，更新 `cut_files` 和 `last_selection`
- **选择与上次相同**：触发智能操作菜单，更新 `last_selection`
- **没有文件**：返回 `(False, False)`，更新 `last_selection = []`
- **文件不存在**：即使选择相同，如果文件不存在，也返回 `(False, False)`，不显示菜单

### 3. 状态管理
- **last_selection 更新时机**：
  - 在比较选择之前就更新 `last_selection`（不管文件是否存在）
  - 有文件 → 更新为当前选择列表
  - 没有文件 → 更新为空列表 `[]`
- **last_selection 重置时机**：
  - 用户完成操作（复制/压缩/解压/MD转换）→ 重置为 `None`（通过 `_reset_last_selection()`）
  - 用户按 ESC 或点击外部关闭菜单 → 保持 `last_selection` 不变（允许下次继续显示菜单）

### 4. 智能操作菜单
- **触发条件**：选择与上次相同时触发
- **菜单显示**：在状态栏图标位置显示菜单，支持键盘导航（上下键选择，回车确认，ESC 取消）
- **操作选项**：
  - **复制路径**：将文件路径列表复制到剪贴板
  - **压缩为 ZIP**：调用 `compress_to_zip()` 压缩文件
  - **智能解压**：调用 `decompress_archive()` 解压压缩文件
  - **MD 转 HTML**：调用 `convert_md_to_html()` 转换 Markdown 文件
  - **MD 转 PDF**：调用 `convert_md_to_pdf()` 转换 Markdown 文件
  - **取消**：用户按 ESC 或点击外部关闭菜单时，不执行任何操作，保持 `last_selection` 不变（允许下次继续显示菜单）

### 5. 操作处理流程
- **复制路径**：直接复制，通知成功
- **压缩/解压**：执行操作，根据结果通知成功或失败
- **所有操作完成后**：重置 `last_selection = None`

## 状态栏菜单结构

### 完整菜单配置示例

```
状态栏图标菜单
  ├── 许可信息
  │   ├── 试用期 (剩余 N 天) / ⚠ 试用期已结束
  │   ├── 激活 / 购买（子菜单，点击展开）
  │   │   ├── 机器码: CMDX-XXXXXXXX (禁用，仅显示)
  │   │   ├── ────────────────
  │   │   ├── ⭐ 购买激活码（打开购买页面）
  │   │   ├── 📋 复制机器码（复制到剪贴板）
  │   │   ├── 🌐 访问官网续7天（打开官网并延长试用期7天，无限制，每次都可以续期）
  │   │   ├── ────────────────
  │   │   └── 🔑 输入激活码（点击后显示简洁输入框）
  │   │       └── 输入框：请输入激活码（2位）
  │   │           ├── 激活成功：通知显示"🎉 激活成功，试用期已延长1年，剩余 X 天"
  │   │           └── 激活失败：通知显示"❌ 激活失败，激活码无效，请检查后重试"
  │   └── 延长试用期（7天）（仅在可延长时显示）
  ├── ────────────────
  ├── 功能区
  │   ├── 无待移动文件 / 待移动 N 个文件
  │   ├── 清空列表
  │   ├── 文件智能操作
  │   │   ├── 💡 重复 ⌘+X 时自动显示 
  │   │   ├── ────────────────
  │   │   └── 操作选项（根据配置显示）
  │   │       ├── 压缩文件
  │   │       ├── 解压缩文件
  │   │       ├── MD 转 HTML
  │   │       ├── MD 转 PDF
  │   │       └── 复制文件路径
  │   └── 配置选项
  │       ├── ⚙️ 配置显示项 (标题，禁用)
  │       ├── ☑ 压缩文件 (子菜单，点击不关闭主菜单)
  │       │   ├── 启用/禁用 (复选框，可点击)
  │       │   └── ↓ 下移 (可点击，调整顺序)
  │       ├── ☑ 解压缩文件 (子菜单，点击不关闭主菜单)
  │       │   ├── 启用/禁用 (复选框，可点击)
  │       │   ├── ↑ 上移 (可点击，调整顺序)
  │       │   └── ↓ 下移 (可点击，调整顺序)
  │       ├── ☑ MD 转 HTML (子菜单，点击不关闭主菜单)
  │       │   ├── 启用/禁用 (复选框，可点击)
  │       │   ├── ↑ 上移 (可点击，调整顺序)
  │       │   └── ↓ 下移 (可点击，调整顺序)
  │       ├── ☑ MD 转 PDF (子菜单，点击不关闭主菜单)
  │       │   ├── 启用/禁用 (复选框，可点击)
  │       │   ├── ↑ 上移 (可点击，调整顺序)
  │       │   └── ↓ 下移 (可点击，调整顺序)
  │       └── ☑ 复制文件路径 (子菜单，点击不关闭主菜单)
  │           ├── 启用/禁用 (复选框，可点击)
  │           └── ↑ 上移 (可点击，调整顺序)
  │       ├── ────────────────
  │       └── 📝 编辑配置文件 (打开配置文件进行编辑)
  ├── ────────────────
  ├── 系统设置
  │   ├── 已获得系统权限 / 未获得系统权限 (点击授权)
  │   └── 开机自启 (复选框)
  ├── ────────────────
  ├── 关于
  │   ├── 显示应用信息和许可证状态
  │   └── 访问官网（打开 GitHub 链接）
  └── 退出 (⌘Q)
```

### 菜单说明

- **许可信息**：显示许可证状态，统一管理激活、购买和延长试用期
  - 显示试用期剩余天数或已过期状态
  - **激活 / 购买**：子菜单设计，点击展开子菜单（不使用弹窗）
    - **子菜单结构**：
      - **机器码显示**：显示当前机器码（禁用项，仅用于查看）
      - **购买激活码**：点击后打开购买页面（问卷链接），自动复制机器码到剪贴板
      - **复制机器码**：点击后复制机器码到剪贴板，显示通知"✅ 已复制，机器码已复制到剪贴板"
      - **访问官网续7天**：点击后打开官网（GitHub 链接），并延长试用期7天（无限制，每次都可以续期）
      - **输入激活码**：点击后显示简洁输入对话框（最小化弹窗，仅包含输入框和按钮）
        - 输入框：请输入激活码（2位）
        - 激活成功：显示通知"🎉 激活成功，试用期已延长1年，剩余 X 天"，自动刷新菜单
        - 激活失败：显示通知"❌ 激活失败，激活码无效，请检查后重试"
    - **激活码说明**：激活码激活时延长试用期1年（365天），不是永久激活
      - 可以多次激活，每次激活都会延长1年
  - **延长试用期（7天）**：如果距离上次延长≥7天，可以延长试用期7天
    - 每7天可以延长一次，延长7天
    - 延长后刷新菜单，更新许可证状态显示
    - 注意：此选项仅在 `can_extend_trial()` 返回 True 时显示
- **功能区**：显示待移动文件状态，支持清空列表和智能操作
- **文件智能操作**：
  - 重复 ⌘+X 选择相同文件时自动显示
  - 支持键盘导航（上下键选择，回车确认，ESC 取消）
  - 可配置显示的操作选项（通过复选框）
  - 操作选项的显示顺序与配置选项的顺序一致
- **配置选项**：
  - 每个配置项使用子菜单结构，点击配置项时展开子菜单，主菜单保持打开（不关闭）
  - 子菜单中包含"启用/禁用"选项（复选框）和"上移/下移"选项（调整顺序）
  - 第一个配置项的子菜单只显示"↓ 下移"，最后一个配置项的子菜单只显示"↑ 上移"
  - 主菜单项标题显示复选框状态（☑ 启用 / ☐ 禁用）
  - 顺序调整后自动保存，并在"文件智能操作"菜单中同步显示
  - 优化体验：点击配置项展开子菜单，主菜单不关闭，方便连续操作多个配置项
  - **编辑配置文件**：高级选项，点击后使用系统默认编辑器打开配置文件，方便直接编辑配置（有利于后续智能化扩展）
- **系统设置**：权限管理和开机自启配置
- **关于**：
  - 显示应用信息、版本、作者联系方式
  - 显示许可证状态（试用期剩余/试用期已结束）
  - 如果已使用激活码，显示"已使用激活码延长"提示
  - **访问官网**：打开 GitHub 项目链接

## 关键代码位置

- **事件捕获**: `src/event_tap.py` - `EventTap._callback()`
- **主逻辑**: `src/app.py` - `CommondXApp.on_cut()`
- **选择管理**: `src/cut_manager.py` - `CutManager.cut()`
- **菜单显示**: `src/status_bar.py` - `show_smart_operations_menu()`（使用状态栏菜单，支持键盘导航）
- **菜单配置**: `src/status_bar.py` - `setup_menu()`（构建完整菜单结构）
  - `_build_smart_ops_menu()`: 根据配置动态构建智能操作菜单
  - `_build_config_menu()`: 构建配置选项菜单
- **操作处理**: `src/status_bar.py` - 各 `smart*_()` 方法（处理具体的智能操作）
  - `_execute_smart_operation()`: 执行智能操作的通用方法，操作完成后重置 `last_selection`
  - `_reset_last_selection()`: 重置 `last_selection` 为 `None`
- **粘贴操作**: `src/app.py` - `CommondXApp.on_paste()`（处理 ⌘+V 事件）
- **压缩解压**: `src/archive_manager.py`
  - `compress_to_zip()`: 压缩文件为 ZIP
  - `decompress_archive()`: 解压压缩文件
- **文件转换**: `src/utils.py`
  - `convert_md_to_html()`: 将 Markdown 转换为 HTML
  - `convert_md_to_pdf()`: 将 Markdown 转换为 PDF
- **许可证管理**: `src/license_manager.py` - `LicenseManager`（试用期管理、激活验证、延长试用期）
  - `activate()`: 激活码激活时延长试用期1年（365天），可多次激活
  - `extend_trial()`: 每7天可延长7天试用期（需要满足时间间隔要求）
  - `extend_trial_unlimited()`: 无限制延长试用期7天（用于访问官网续期，每次都可以续期）
  - `can_extend_trial()`: 检查是否可以延长试用期（检查时间间隔）
  - `get_status()`: 返回试用期状态（trial/expired）和剩余天数
- **激活/购买菜单**: `src/status_bar.py` - 相关方法
  - `showActivationInput_()`: 显示激活对话框，输入激活码
  - `openBuyPage_()`: 打开购买页面，自动复制机器码
  - `copyMachineCode_()`: 复制机器码到剪贴板
  - `visitWebsiteExtendTrial_()`: 访问官网并延长试用期7天（无限制）
  - `extendTrial_()`: 延长试用期7天（需要满足时间间隔要求）
- **关于菜单**: `src/status_bar.py` - `showAbout_()`（显示应用信息、访问官网）