# CommondX 处理流程图

## Cmd+X 快捷键处理流程

```mermaid
flowchart TD
    Start(["用户按下 Cmd+X"]) --> EventTap[EventTap 捕获键盘事件]
    EventTap --> CheckKey{是否为 Cmd+X?}
    CheckKey -->|否| PassEvent[放行事件]
    CheckKey -->|是| CheckFinder{是否为 Finder 窗口?}
    CheckFinder -->|否| PassEvent
    CheckFinder -->|是| CheckLicense{检查许可证}
    
    CheckLicense -->|无效| ShowActivation[显示激活提示]
    CheckLicense -->|有效| OnCut["调用 app.on_cut"]
    
    OnCut --> CallCut["调用 cut_manager.cut"]
    
    CallCut --> GetSelection["获取 Finder 选中文件(没有则空列表)"]
    GetSelection --> CompareSelection["比较当前选择与上一次选择(保存比较结果)"]
    CompareSelection --> UpdateLast["更新 last_selection = 当前选择(空列表也记录)"]
    UpdateLast --> HasFiles{是否有文件?}
    HasFiles -->|否| ReturnFalse["返回 False, False"]
    HasFiles -->|是| IsSame{选择是否相同?}
    IsSame -->|是| ShowDialog["返回 True, True 触发智能操作弹窗"]
    IsSame -->|否| ValidateFiles["验证文件是否存在(仅用于剪切操作)"]
    ValidateFiles --> FilesValid{文件有效?}
    FilesValid -->|否| ReturnFalse
    FilesValid -->|是| DoCut["执行剪切操作(更新 cut_files, 返回 True, False)"]
    
    ShowDialog --> CloseOldDialog{是否有旧弹窗?}
    CloseOldDialog -->|是| StopModal["关闭旧弹窗(NSApp.stopModal)"]
    CloseOldDialog -->|否| ShowFileDialog[显示文件智能操作弹窗]
    StopModal --> ShowFileDialog
    
    ShowFileDialog --> UserChoice{用户选择操作}
    UserChoice -->|复制路径| CopyPaths[复制文件路径到剪贴板]
    UserChoice -->|压缩为ZIP| Compress[调用 compress_to_zip]
    UserChoice -->|智能解压| Decompress[调用 decompress_archive]
    UserChoice -->|取消| ResetLastSelection["重置 last_selection = None"]
    
    CopyPaths --> NotifyCopy["通知: 已复制路径"]
    Compress --> NotifyCompress{压缩成功?}
    Decompress --> NotifyDecompress{解压成功?}
    
    NotifyCompress -->|是| NotifySuccess1["通知: 压缩成功"]
    NotifyCompress -->|否| NotifyFail1["通知: 压缩失败"]
    NotifyDecompress -->|是| NotifySuccess2["通知: 解压成功"]
    NotifyDecompress -->|否| NotifyFail2["通知: 解压失败"]
    
    NotifyCopy --> ResetLastSelection
    NotifySuccess1 --> ResetLastSelection
    NotifyFail1 --> ResetLastSelection
    NotifySuccess2 --> ResetLastSelection
    NotifyFail2 --> ResetLastSelection
    ResetLastSelection --> End1[结束]
    
    DoCut --> SendNotify["发送通知: 已剪切 N 个文件"]
    SendNotify --> End2[结束]
    ReturnFalse --> End3[结束]
    ShowActivation --> End4[结束]
    PassEvent --> End5[结束]
```

## 状态跟踪逻辑


## 核心设计逻辑

### 1. 选择比较机制
- 使用 `set()` 比较文件列表，忽略顺序
- 只比较当前选择和上一次选择

### 2. 处理规则
- **选择与上次不同**：执行剪切
- **选择与上次相同**：触发智能操作弹窗

### 3. 智能操作弹窗
- 当选择与上次相同时触发
- 如果已有弹窗显示，先关闭旧弹窗再显示新弹窗
- 显示文件列表和可用操作
- 根据文件类型智能显示按钮：
  - 全部是压缩文件 → 显示"智能解压"
  - 有普通文件/文件夹 → 显示"压缩为 ZIP"
  - 始终显示"复制路径"

### 4. 操作处理
- **复制路径**：将文件路径列表复制到剪贴板
- **压缩为 ZIP**：调用 `compress_to_zip()` 压缩文件
- **智能解压**：调用 `decompress_archive()` 解压压缩文件
- **取消**：不执行任何操作
- **所有操作完成后**：重置 `last_selection = None`

## 关键代码位置

- **事件捕获**: `src/event_tap.py` - `EventTap._callback()`
- **主逻辑**: `src/app.py` - `CommondXApp.on_cut()`
- **选择管理**: `src/cut_manager.py` - `CutManager.cut()`
- **弹窗显示**: `src/file_dialog.py` - `show_file_operations_dialog()`
- **操作处理**: `src/app.py` - `CommondXApp._handle_file_operation()`
