# CommondX 处理流程图

## ⌘+X 快捷键处理流程

```mermaid
flowchart TD
    Start(["用户按下 ⌘+X"]) --> EventTap[EventTap 捕获键盘事件]
    EventTap --> CheckKey{是否为 ⌘+X?}
    CheckKey -->|否| PassEvent[放行事件]
    CheckKey -->|是| CheckFinder{是否为 Finder 窗口?}
    CheckFinder -->|否| PassEvent
    CheckFinder -->|是| CheckLicense{检查许可证}
    
    CheckLicense -->|无效| ShowActivation[显示激活提示]
    CheckLicense -->|有效| OnCut["调用 app.on_cut()"]
    
    OnCut --> CallCut["调用 cut_manager.cut()"]
    CallCut --> GetSelection["获取 Finder 选中文件<br/>(没有则返回空列表)"]
    GetSelection --> HasFiles{是否有文件?}
    
    HasFiles -->|否| UpdateLastEmpty["更新 last_selection = []"]
    HasFiles -->|是| CompareSelection["比较当前选择与上一次选择<br/>(使用 set 比较，忽略顺序)"]
    
    CompareSelection --> IsSame{选择是否相同?}
    IsSame -->|是| UpdateLastSame["更新 last_selection = 当前选择"]
    IsSame -->|否| ValidateFiles["验证文件是否存在"]
    
    UpdateLastSame --> ReturnShowDialog["返回 (True, True)<br/>触发智能操作菜单"]
    UpdateLastEmpty --> ReturnFalse["返回 (False, False)"]
    
    ValidateFiles --> FilesValid{文件有效?}
    FilesValid -->|否| ReturnFalse
    FilesValid -->|是| DoCut["执行剪切操作<br/>(更新 cut_files, 更新 last_selection = 当前选择)"]
    
    DoCut --> SendNotify["发送通知: 已剪切 N 个文件"]
    SendNotify --> End[结束]
    
    ReturnShowDialog --> ShowMenu[显示文件智能操作菜单<br/>（状态栏菜单，支持键盘导航）]
    
    ShowMenu --> UserChoice{用户选择操作<br/>（键盘上下键选择，回车确认）}
    UserChoice -->|复制路径| CopyPaths[复制文件路径到剪贴板]
    UserChoice -->|压缩为ZIP| Compress[调用 compress_to_zip]
    UserChoice -->|智能解压| Decompress[调用 decompress_archive]
    UserChoice -->|取消| ResetLastSelection["重置 last_selection = None<br/>(保持状态以便重试)"]
    
    CopyPaths --> NotifySuccess["通知操作结果"]
    Compress --> CheckCompress{压缩成功?}
    Decompress --> CheckDecompress{解压成功?}
    
    CheckCompress -->|是| NotifySuccess
    CheckCompress -->|否| NotifyFail["通知操作失败"]
    CheckDecompress -->|是| NotifySuccess
    CheckDecompress -->|否| NotifyFail
    
    NotifySuccess --> ResetLastSelection
    NotifyFail --> ResetLastSelection
    ResetLastSelection --> End
    ReturnFalse --> End
    ShowActivation --> End
    PassEvent --> End
```

## 核心设计逻辑

### 1. 选择比较机制
- 使用 `set()` 比较文件列表，忽略顺序
- 空列表 `[]` 和 `None` 被视为相同（都是空选择）
- 比较结果决定是执行剪切还是显示智能操作菜单

### 2. 处理规则
- **选择与上次不同**：执行剪切，更新 `cut_files` 和 `last_selection`
- **选择与上次相同**：触发智能操作菜单，更新 `last_selection`
- **没有文件**：返回 `(False, False)`，更新 `last_selection = []`

### 3. 状态管理
- **last_selection 更新时机**：
  - 有文件且选择不同 → 执行剪切后更新为当前选择
  - 有文件且选择相同 → 比较后更新为当前选择
  - 没有文件 → 更新为空列表 `[]`
- **last_selection 重置时机**：
  - 用户选择"取消" → 重置为 `None`（保持状态以便重试）
  - 用户完成操作（复制/压缩/解压）→ 重置为 `None`

### 4. 智能操作菜单
- **触发条件**：选择与上次相同时触发
- **菜单显示**：在状态栏图标位置显示菜单，支持键盘导航（上下键选择，回车确认，ESC 取消）
- **操作选项**：
  - **复制路径**：将文件路径列表复制到剪贴板
  - **压缩为 ZIP**：调用 `compress_to_zip()` 压缩文件
  - **智能解压**：调用 `decompress_archive()` 解压压缩文件
  - **MD 转 HTML**：调用 `convert_md_to_html()` 转换 Markdown 文件
  - **MD 转 PDF**：调用 `convert_md_to_pdf()` 转换 Markdown 文件
  - **取消**：不执行任何操作，保持 `last_selection` 不变（允许下次继续显示菜单）

### 5. 操作处理流程
- **复制路径**：直接复制，通知成功
- **压缩/解压**：执行操作，根据结果通知成功或失败
- **所有操作完成后**：重置 `last_selection = None`

## 状态栏菜单结构

### 完整菜单配置示例

```
状态栏图标菜单
  ├── 许可信息
  │   ├── 试用期 (剩余 N 天) / ⚠ 试用期已结束 / ✓ 已激活
  │   └── 激活 / 购买...
  ├── ────────────────
  ├── 功能区
  │   ├── 无待移动文件 / 待移动 N 个文件
  │   ├── 清空列表
  │   └── 文件智能操作
  │       ├── 💡 重复 ⌘+X 时自动显示
  │       ├── ────────────────
  │       ├── 操作选项（根据配置显示）
  │       │   ├── 压缩文件
  │       │   ├── 解压缩文件
  │       │   ├── MD 转 HTML
  │       │   ├── MD 转 PDF
  │       │   └── 复制文件路径
  │       ├── ────────────────
  │       └── 配置选项
  │           ├── ⚙️ 配置显示项 (标题，禁用)
  │           ├── ☑ 压缩文件 (复选框，可点击)
  │           ├── ☑ 解压缩文件 (复选框，可点击)
  │           ├── ☑ MD 转 HTML (复选框，可点击)
  │           ├── ☑ MD 转 PDF (复选框，可点击)
  │           └── ☑ 复制文件路径 (复选框，可点击)
  ├── ────────────────
  ├── 系统设置
  │   ├── 已获得系统权限 / 未获得系统权限 (点击授权)
  │   └── 开机自启 (复选框)
  ├── ────────────────
  ├── 关于
  └── 退出 (⌘Q)
```

### 菜单说明

- **许可信息**：显示许可证状态，支持激活和购买
- **功能区**：显示待移动文件状态，支持清空列表和智能操作
- **文件智能操作**：
  - 重复 ⌘+X 选择相同文件时自动显示
  - 支持键盘导航（上下键选择，回车确认，ESC 取消）
  - 可配置显示的操作选项（通过复选框）
- **系统设置**：权限管理和开机自启配置

## 关键代码位置

- **事件捕获**: `src/event_tap.py` - `EventTap._callback()`
- **主逻辑**: `src/app.py` - `CommondXApp.on_cut()`
- **选择管理**: `src/cut_manager.py` - `CutManager.cut()`
- **菜单显示**: `src/status_bar.py` - `show_smart_operations_menu()`（使用状态栏菜单，支持键盘导航）
- **菜单配置**: `src/status_bar.py` - `_build_smart_ops_menu()`（根据配置动态构建菜单）
- **操作处理**: `src/status_bar.py` - 各 `smart*_()` 方法（处理具体的智能操作）
