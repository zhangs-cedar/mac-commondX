# CommondX 处理流程图

## Cmd+X 快捷键处理流程

```mermaid
flowchart TD
    Start(["用户按下 Cmd+X"]) --> EventTap[EventTap 捕获键盘事件]
    EventTap --> CheckKey{是否为 Cmd+X?}
    CheckKey -->|否| PassEvent[放行事件]
    CheckKey -->|是| CheckFinder{是否为 Finder 窗口?}
    CheckFinder -->|否| PassEvent
    CheckFinder -->|是| CheckLicense{检查许可证}
    
    CheckLicense -->|无效| ShowActivation[显示激活提示]
    CheckLicense -->|有效| OnCut["调用 app.on_cut"]
    
    OnCut --> CallCut["调用 cut_manager.cut"]
    
    CallCut --> GetSelection["获取 Finder 选中文件(没有则空列表)"]
    GetSelection --> CompareSelection["比较当前选择与上一次选择(保存比较结果)"]
    CompareSelection --> UpdateLast["更新 last_selection = 当前选择(空列表也记录)"]
    UpdateLast --> HasFiles{是否有文件?}
    HasFiles -->|否| ReturnFalse["返回 False, False"]
    HasFiles -->|是| IsSame{选择是否相同?}
    IsSame -->|是| ShowDialog["返回 True, True 触发智能操作弹窗"]
    IsSame -->|否| ValidateFiles["验证文件是否存在(仅用于剪切操作)"]
    ValidateFiles --> FilesValid{文件有效?}
    FilesValid -->|否| ReturnFalse
    FilesValid -->|是| DoCut["执行剪切操作(更新 cut_files, 返回 True, False)"]
    
    ShowDialog --> CloseOldDialog{是否有旧弹窗?}
    CloseOldDialog -->|是| StopModal["关闭旧弹窗(NSApp.stopModal)"]
    CloseOldDialog -->|否| ShowFileDialog[显示文件智能操作弹窗]
    StopModal --> ShowFileDialog
    
    ShowFileDialog --> UserChoice{用户选择操作}
    UserChoice -->|复制路径| CopyPaths[复制文件路径到剪贴板]
    UserChoice -->|压缩为ZIP| Compress[调用 compress_to_zip]
    UserChoice -->|智能解压| Decompress[调用 decompress_archive]
    UserChoice -->|取消| ResetLastSelection["重置 last_selection = None"]
    
    CopyPaths --> NotifyCopy["通知: 已复制路径"]
    Compress --> NotifyCompress{压缩成功?}
    Decompress --> NotifyDecompress{解压成功?}
    
    NotifyCompress -->|是| NotifySuccess1["通知: 压缩成功"]
    NotifyCompress -->|否| NotifyFail1["通知: 压缩失败"]
    NotifyDecompress -->|是| NotifySuccess2["通知: 解压成功"]
    NotifyDecompress -->|否| NotifyFail2["通知: 解压失败"]
    
    NotifyCopy --> ResetLastSelection
    NotifySuccess1 --> ResetLastSelection
    NotifyFail1 --> ResetLastSelection
    NotifySuccess2 --> ResetLastSelection
    NotifyFail2 --> ResetLastSelection
    ResetLastSelection --> End1[结束]
    
    DoCut --> SendNotify["发送通知: 已剪切 N 个文件"]
    SendNotify --> End2[结束]
    ReturnFalse --> End3[结束]
    ShowActivation --> End4[结束]
    PassEvent --> End5[结束]
```
